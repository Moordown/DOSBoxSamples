# pe - формат исполняемых файлов в win

### [Сайт с описанием исоплняемых файлов в win](cs.usu.edu.eu/docs/pe/)


Эти библиотеки отображаются в виртуальную память всех выполняемых программ.
модель памяти - flat

ntdll.dll 
kernel32.dll - библиотека для работы с пользователем

динамические библиотеки гораздо сильнее интегрированы в win, чем в linux, поэтому дажу простую программу мы должны очень сильно наполнять dll

### Коды 

win - ОС с закрытым кодом, поэтому в win мы просто делаем syscall, код которого подставляется в вызов из статической библиотеки, которая прикрепляется к выполняемому файлу

#### [msdn - документация windows](https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-readfile)

надо, чтобы были установлены 

ml64

cl

link

dumpbin

[clang](clang.llvm.org)

clang -S 3 calls.s calls.c

[call conventions](https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-readfile)

alignment - stack aligned to 16 bytes => al == 0

младшие части регистров для адреса - для сравнения с нулем:

sil, dil, spl 

почему: многие команды выбирают аргументы парами - поэтому выравниваем на 16 (для sse)

в стек кладутся все адреса, потом четыре пустых слова, которые даются подпрограмме под полное ее распоряжение, потом все с пятого и до конца (первые четыре кладутся в регистры)


                                +---------+
                                |    0    |
                                +---------+
                                |    7    |
                                +---------+
                                |    6    |
                                +---------+
                                |    5    |
                                +---------+
                                |    x    |
                                +---------+
                                |    x    |
                                +---------+
                                |    x    |
                                +---------+
                                |    x    |
                                +---------+
                           ---> | retaddr |
                                +---------+


граф потока выполнения очень ветвистый и достаточно произвольный

[выход](./h0.asm)

[cmd](./get.cmd)
ml64 - транслируем
echo - говорим
/defaultlib:f:\test\kernel32.lib - полный путь до библиотеки
/LARGEADDRESSAWARE:NO - строим 32битное приложение, работающее в 64битной среде (в виндовсе и потоков и процессов больше, поэтмоу, чтобы экономить память, мы даем возможность построить приложение с маленькими требованиями по адресу)

### Табоица импорта
/bindump /import h0.exe 

### В exe файле символы не хранятся

### Самый лучший отладчик - ida

[hello.asm](./hello.asm) - программа с handle

lea - move offset