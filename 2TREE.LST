Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 1
2tree.ASM



      1					 include macro.asm
1     2					 load macro args
1     3					     irp d,<args>
1     4						 push d
1     5					     endm
1     6					 endm
1     7
1     8					 restore macro args
1     9					     irp d,<args>
1    10						 pop d
1    11					     endm
1    12					 endm
1    13
1    14					 exit macro
1    15					     mov ah, 00h
1    16					     int 21h
1    17					 endm
1    18
1    19					 print macro buf
1    20						 mov ah, 09h
1    21						 mov dx, buf
1    22						 int 21h
1    23					 endm
1    24
1    25					 print_range macro args
1    26					     irp d,<args>
1    27						 print <offset d>
1    28					     endm
1    29					 endm
1    30
1    31					 break_point macro arg
1    32					     load <arg>
1    33					     xor arg, arg
1    34					     xor arg, arg
1    35					     xor arg, arg
1    36					     xor arg, arg
1    37					     xor arg, arg
1    38					     xor arg, arg
1    39					     xor arg, arg
1    40					     xor arg, arg
1    41					     restore <arg>
1    42					 endm
1    43
1    44					 get_offset macro state
1    45					     xor dx, dx
1    46					     xor ax, ax
1    47					     mov al, state
1    48					     shl ax, 8
1    49					 endm get_offset
1    50
1    51					 to_non_space macro addr
1    52					     local l1, l2
1    53					     mov si, addr
1    54					 l1:
1    55					     mov byte ptr al, [si]
1    56					     cmp al, 20h
1    57					     je	l2
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 2
2tree.ASM



1    58					     cmp al, 0
1    59					     je	l2
1    60					     inc si
1    61					     jmp l1
1    62					 l2:
1    63					     inc si
1    64					     mov ax, si
1    65					 endm
1    66
1    67					 set_transition	macro buf, from, to, char
1    68					     load<bx, dx>
1    69					     get_offset	from
1    70
1    71					     add ax, offset buf
1    72					     add ax, char
1    73
1    74					     mov bx, ax
1    75					     mov byte ptr [bx],	to
1    76					     restore<dx, bx>
1    77					 endm
1    78
1    79					 set_transition_length_from_start macro	buf, from, to, start, iterations
1    80					     local l1, end
1    81					     mov bx, start
1    82					     mov cx, iterations
1    83					 l1:
1    84					     cmp cx, 0
1    85					     je	end
1    86
1    87					     load <bx,cx>
1    88					     set_transition buf	from to	bx
1    89					     restore <cx,bx>
1    90
1    91					     inc bx
1    92					     dec cx
1    93					     jmp l1
1    94					 end:
1    95					 endm
1    96
1    97					 set_zero macro	state
1    98					     mov al, 0
1    99					     mov byte ptr [state], al
1   100					 endm
1   101
1   102					 set_transition_for_all	macro buf, from, to
1   103					     set_transition_length_from_start buf, from, to, 0,	255
1   104					 endm
1   105
1   106					 set_transition_for_digits macro buf, from, to
1   107					     set_transition_length_from_start buf, from, to, 30, 10
1   108					 endm
1   109
1   110					 set_transition_for_letters macro buf, from, to
1   111					     set_transition_length_from_start buf, from, to, 97, 26
1   112					     set_transition_length_from_start buf, from, to, 65, 26
1   113					 endm
1   114
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 3
2tree.ASM



1   115					 get_transition	macro buf, from, char
1   116					     load <dx>
1   117					     get_offset	from
1   118					     restore <dx>
1   119
1   120					     add ax, offset buf
1   121					     add ax, char
1   122
1   123					     mov bx, ax
1   124					     xor ax, ax
1   125					     mov al, byte ptr [bx]
1   126					 endm
1   127
1   128					 put macro from, to, position
1   129					     xor dx, dx
1   130					     xor bx, bx
1   131
1   132					     mov dx, offset to
1   133					     mov bl, byte ptr [position]
1   134					     add dx, bx
1   135
1   136					     mov bl, byte ptr [from]
1   137					     mov byte ptr [edx], bl
1   138					     inc [position]
1   139					 endm
1   140
1   141					 clear_mes macro mes, lastidx
1   142					     local l1, end
1   143					     mov bx, offset mes
1   144					     mov cl, byte ptr [lastidx]
1   145					     inc cl
1   146					 l1:
1   147					     cmp cl, 0
1   148					     je	end
1   149					     mov byte ptr [bx],	'$'
1   150					     inc bx
1   151					     dec cl
1   152					     jmp l1
1   153					 end:
1   154					     mov bl, 0
1   155					     mov byte ptr [lastidx], bl
1   156					 endm
    157
    158	    0000			 model tiny
    159					 .386
    160	    0000			 .code
    161					 org 100h
    162	    0100			 start:
    163	    0100  E8 02D7		     call save_cwd
    164	    0103  B9 0000		     mov cx, 0
    165	    0106  51			     push cx
    166	    0107  E8 02B8		     call set_dta
    167	    010A  E8 019A		     call parse_command_line
    168
    169					     ;
    170					     ;	 start tree
    171					     ;
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 4
2tree.ASM



    172	    010D  B8 0545r		     mov ax, offset root_folder
    173	    0110  B9 0000		     mov cx, 0
    174	    0113  51			     push cx
    175	    0114  50			     push ax
    176	    0115  E8 001D		     call list_subfiles_recursive_from
    177
    178					     ;
    179					     ;	 cd to start folder
    180					     ;
    181	    0118  B8 0505r		     mov ax, offset working_folder
    182	    011B  50			     push ax
    183					     break_point <ax>
1   184					     load <ax>
3   185	    011C  50				 push ax
1   186	    011D  33 C0			     xor ax, ax
1   187	    011F  33 C0			     xor ax, ax
1   188	    0121  33 C0			     xor ax, ax
1   189	    0123  33 C0			     xor ax, ax
1   190	    0125  33 C0			     xor ax, ax
1   191	    0127  33 C0			     xor ax, ax
1   192	    0129  33 C0			     xor ax, ax
1   193	    012B  33 C0			     xor ax, ax
1   194					     restore <ax>
3   195	    012D  58				 pop ax
    196	    012E  E8 0264		     call cd
    197					     exit
1   198	    0131  B4 00			     mov ah, 00h
1   199	    0133  CD 21			     int 21h
    200
    201	    0135			 list_subfiles_recursive_from:
    202	    0135  5B			     pop bx	 ; ret address
    203	    0136  58			     pop ax	 ; deep	level
    204	    0137  59			     pop cx	 ; root	folder offset
    205	    0138  53			     push bx
    206					     load <cx>
2   207	    0139  51				 push cx
    208	    013A  50			     push ax
    209	    013B  E8 0257		     call cd
    210					     restore <cx>
2   211	    013E  59				 pop cx
    212
    213					     ;
    214					     ; list subfolder
    215					     ;
    216	    013F  BE 02F7r		     mov si, offset find_first_folder
    217	    0142  BB 0000		     mov bx, 0
    218	    0145  B8 04E2r		     mov ax, offset folder_mask
    219					     load <cx>
2   220	    0148  51				 push cx
    221	    0149  56			     push si
    222	    014A  53			     push bx
    223	    014B  50			     push ax
    224	    014C  51			     push cx
    225	    014D  E8 0013		     call list_subfiles_recursive
    226					     restore <cx>
2   227	    0150  59				 pop cx
    228
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 5
2tree.ASM



    229					     ;
    230					     ; list files
    231					     ;
    232	    0151  BE 02EAr		     mov si, offset find_first_file
    233	    0154  8B D8			     mov bx, ax
    234	    0156  B8 04DCr		     mov ax, offset file_mask
    235					     load <cx>
2   236	    0159  51				 push cx
    237	    015A  56			     push si
    238	    015B  53			     push bx
    239	    015C  50			     push ax
    240	    015D  51			     push cx
    241	    015E  E8 0002		     call list_subfiles_recursive
    242					     restore <cx>
2   243	    0161  59				 pop cx
    244	    0162  C3			     ret
    245
    246	    0163			 list_subfiles_recursive:
    247					     ;
    248					     ;	 save current files
    249					     ;
    250	    0163  E8 02C7		     call count_subfiles_here
    251	    0166  A3 04D7r		     mov word ptr [current_max_entities], ax
    252
    253	    0169  5A			     pop dx
    254	    016A  59			     pop cx ; deep level
    255	    016B  58			     pop ax ; filemask offset
    256	    016C  5B			     pop bx ; current index
    257	    016D  5E			     pop si ; search address
    258	    016E  52			     push dx
    259
    260					     load <cx, ax, bx, si>
2   261	    016F  51				 push cx
2   262	    0170  50				 push ax
2   263	    0171  53				 push bx
2   264	    0172  56				 push si
    265	    0173  51			     push cx
    266	    0174  E8 024B		     call set_dta
    267					     restore <si, bx, ax, cx>
2   268	    0177  5E				 pop si
2   269	    0178  5B				 pop bx
2   270	    0179  58				 pop ax
2   271	    017A  59				 pop cx
    272
    273					     load <bx, cx>
2   274	    017B  53				 push bx
2   275	    017C  51				 push cx
    276	    017D  50			     push ax
    277	    017E  FF D6			     call si
    278	    0180  73 03			     jnc _list_subfiles_recursive_loop
    279	    0182  E9 00C7		     jmp _list_subfiles_recursive_end
    280	    0185			 _list_subfiles_recursive_loop:
    281					     restore <cx>
2   282	    0185  59				 pop cx
    283	    0186  51			     push cx
    284	    0187  E8 017A		     call is_valid_name
    285					     load <cx>
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 6
2tree.ASM



2   286	    018A  51				 push cx
    287	    018B  3D 0001		     cmp ax, 1
    288	    018E  0F 85	00AD		     jne _list_subfiles_recursive_next
    289
    290					     ;
    291					     ;	 increment current index in subfiles
    292					     ;
    293					     restore <cx, bx>
2   294	    0192  59				 pop cx
2   295	    0193  5B				 pop bx
    296	    0194  43			     inc bx
    297					     load <bx, cx>
2   298	    0195  53				 push bx
2   299	    0196  51				 push cx
    300	    0197  53			     push bx
    301	    0198  51			     push cx
    302	    0199  E8 0180		     call show_filename_from_dta
    303
    304					     ;
    305					     ;	 check if folder
    306					     ;
    307					     restore <cx>
2   308	    019C  59				 pop cx
    309					     load <cx>
2   310	    019D  51				 push cx
    311	    019E  51			     push cx
    312	    019F  E8 00C1		     call is_folder
    313	    01A2  3D 0001		     cmp ax, 1
    314	    01A5  0F 85	0096		     jne _list_subfiles_recursive_next
    315
    316					     ;
    317					     ;	 check deep level
    318					     ;
    319					     restore <cx>
2   320	    01A9  59				 pop cx
    321					     load <cx>
2   322	    01AA  51				 push cx
    323	    01AB  33 DB			     xor bx, bx
    324	    01AD  8A 1E	04DBr		     mov bl, byte ptr [deep_level]
    325	    01B1  3B CB			     cmp cx, bx
    326	    01B3  0F 8D	0088		     jge _list_subfiles_recursive_next
    327
    328					     ;
    329					     ;	 pseudographic hack
    330					     ;
    331					     restore <cx, bx>
2   332	    01B7  59				 pop cx
2   333	    01B8  5B				 pop bx
    334					     load <bx, cx>
2   335	    01B9  53				 push bx
2   336	    01BA  51				 push cx
    337
    338	    01BB  3B 1E	04D7r		     cmp bx, word ptr [current_max_entities]
    339	    01BF  75 0A			     jne _list_subfiles_recursive_loop_pseudographic_hack
    340	    01C1  BB 04EAr		     mov bx, offset level_shift
    341	    01C4  03 D9			     add bx, cx
    342	    01C6  A0 04F5r		     mov al, byte ptr [space]
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 7
2tree.ASM



    343	    01C9  88 07			     mov byte ptr [bx],	al
    344	    01CB			 _list_subfiles_recursive_loop_pseudographic_hack:
    345
    346					     ;
    347					     ; start new search
    348					     ;
    349	    01CB  A1 04D7r		     mov ax, word ptr [current_max_entities]
    350					     load <ax>
2   351	    01CE  50				 push ax
    352
    353					     ;
    354					     ;	 cd to subfolder
    355					     ;
    356					     load <cx>
2   357	    01CF  51				 push cx
    358	    01D0  51			     push cx
    359	    01D1  E8 007D		     call move_dta
    360	    01D4  05 001E		     add ax, 1Eh
    361
    362	    01D7  50			     push ax
    363					     break_point <bx>
1   364					     load <bx>
3   365	    01D8  53				 push bx
1   366	    01D9  33 DB			     xor bx, bx
1   367	    01DB  33 DB			     xor bx, bx
1   368	    01DD  33 DB			     xor bx, bx
1   369	    01DF  33 DB			     xor bx, bx
1   370	    01E1  33 DB			     xor bx, bx
1   371	    01E3  33 DB			     xor bx, bx
1   372	    01E5  33 DB			     xor bx, bx
1   373	    01E7  33 DB			     xor bx, bx
1   374					     restore <bx>
3   375	    01E9  5B				 pop bx
    376	    01EA  E8 01A8		     call cd
    377					     restore <cx>
2   378	    01ED  59				 pop cx
    379
    380	    01EE  41			     inc cx
    381					     ;
    382					     ;	 list subfiles from subfolder
    383					     ;
    384					     load <cx>
2   385	    01EF  51				 push cx
    386	    01F0  BB 0000		     mov bx, 0
    387	    01F3  B8 04E2r		     mov ax, offset folder_mask
    388	    01F6  BE 02F7r		     mov si, offset find_first_folder
    389
    390	    01F9  56			     push si
    391	    01FA  53			     push bx
    392	    01FB  50			     push ax
    393	    01FC  51			     push cx
    394	    01FD  E8 FF63		     call list_subfiles_recursive
    395					     restore <cx>
2   396	    0200  59				 pop cx
    397
    398
    399					     ;
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 8
2tree.ASM



    400					     ;	 list subfolders from subfolder
    401					     ;
    402					     load <cx>
2   403	    0201  51				 push cx
    404	    0202  8B D8			     mov bx, ax
    405	    0204  B8 04DCr		     mov ax, offset file_mask
    406	    0207  BE 02EAr		     mov si, offset find_first_file
    407
    408	    020A  56			     push si
    409	    020B  53			     push bx
    410	    020C  50			     push ax
    411	    020D  51			     push cx
    412	    020E  E8 FF52		     call list_subfiles_recursive
    413					     restore <cx>
2   414	    0211  59				 pop cx
    415
    416					     ;
    417					     ;	 reverse pseudographic hack
    418					     ;
    419	    0212  BB 04EAr		     mov bx, offset level_shift
    420	    0215  03 D9			     add bx, cx
    421	    0217  A0 04E8r		     mov al, byte ptr [old_level_shift]
    422	    021A  88 07			     mov byte ptr [bx],	al
    423
    424					     ;
    425					     ;	 cd back to this function
    426					     ;
    427	    021C  B8 0502r		     mov ax, offset parent_folder
    428	    021F  50			     push ax
    429					     break_point <cx>
1   430					     load <cx>
3   431	    0220  51				 push cx
1   432	    0221  33 C9			     xor cx, cx
1   433	    0223  33 C9			     xor cx, cx
1   434	    0225  33 C9			     xor cx, cx
1   435	    0227  33 C9			     xor cx, cx
1   436	    0229  33 C9			     xor cx, cx
1   437	    022B  33 C9			     xor cx, cx
1   438	    022D  33 C9			     xor cx, cx
1   439	    022F  33 C9			     xor cx, cx
1   440					     restore <cx>
3   441	    0231  59				 pop cx
    442	    0232  E8 0160		     call cd
    443
    444					     restore <ax>
2   445	    0235  58				 pop ax
    446	    0236  A3 04D7r		     mov word ptr [current_max_entities], ax
    447
    448					     restore <cx>
2   449	    0239  59				 pop cx
    450					     load <cx>
2   451	    023A  51				 push cx
    452	    023B  51			     push cx
    453	    023C  E8 0183		     call set_dta
    454	    023F			 _list_subfiles_recursive_next:
    455	    023F  E8 00A3		     call find_next
    456	    0242  0F 83	FF3F		     jnc _list_subfiles_recursive_loop
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 9
2tree.ASM



    457	    0246  3A 06	0486r		     cmp al, byte ptr [no_more_files]
    458	    024A  75 49			     jne find_next_error
    459	    024C			 _list_subfiles_recursive_end:
    460					     restore <cx, bx>
2   461	    024C  59				 pop cx
2   462	    024D  5B				 pop bx
    463	    024E  8B C3			     mov ax, bx
    464	    0250  C3			     ret
    465	    0251			 move_dta:
    466	    0251  5B			     pop bx
    467	    0252  59			     pop cx
    468	    0253  53			     push bx
    469
    470	    0254  33 C0			     xor ax, ax
    471	    0256  A0 0487r		     mov al, byte ptr [dta_len]
    472	    0259  F7 E1			     mul cx
    473
    474	    025B  BB 05C7r		     mov bx, offset dta
    475	    025E  03 D8			     add bx, ax
    476	    0260  8B C3			     mov ax, bx
    477	    0262  C3			     ret
    478	    0263			 is_folder:
    479	    0263  5B			     pop bx
    480	    0264  59			     pop cx
    481	    0265  53			     push bx
    482
    483	    0266  51			     push cx
    484	    0267  E8 FFE7		     call move_dta
    485
    486	    026A  05 0015		     add ax, 15h
    487	    026D  8B D8			     mov bx, ax
    488	    026F  8A 1F			     mov bl, byte ptr [bx]
    489	    0271  80 E3	10		     and bl, 10h
    490	    0274  80 FB	10		     cmp bl, 10h
    491	    0277  74 02			     je	_is_folder_true
    492	    0279  75 05			     jne _is_folder_false
    493	    027B			 _is_folder_true:
    494	    027B  B8 0001		     mov ax, 1
    495	    027E  EB 05			     jmp _is_folder_end
    496	    0280			 _is_folder_false:
    497	    0280  B8 0000		     mov ax, 0
    498	    0283  EB 00			     jmp _is_folder_end
    499	    0285			 _is_folder_end:
    500	    0285  C3			     ret
    501
    502	    0286			 find_first_error:
    503					     print_range <find_first_fails, newline>
2   504						 print <offset find_first_fails>
3   505	    0286  B4 09				 mov ah, 09h
3   506	    0288  BA 04A0r			 mov dx, offset	find_first_fails
3   507	    028B  CD 21				 int 21h
2   508						 print <offset newline>
3   509	    028D  B4 09				 mov ah, 09h
3   510	    028F  BA 05C5r			 mov dx, offset	newline
3   511	    0292  CD 21				 int 21h
    512	    0294  C3			     ret
    513	    0295			 find_next_error:
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 10
2tree.ASM



    514					     print_range <find_next_fails, newline>
2   515						 print <offset find_next_fails>
3   516	    0295  B4 09				 mov ah, 09h
3   517	    0297  BA 04BCr			 mov dx, offset	find_next_fails
3   518	    029A  CD 21				 int 21h
2   519						 print <offset newline>
3   520	    029C  B4 09				 mov ah, 09h
3   521	    029E  BA 05C5r			 mov dx, offset	newline
3   522	    02A1  CD 21				 int 21h
    523					     exit
1   524	    02A3  B4 00			     mov ah, 00h
1   525	    02A5  CD 21			     int 21h
    526
    527	    02A7			 parse_command_line:
    528					     ;
    529					     ; prepare root folder
    530					     ;
    531	    02A7  BE 0082		     mov si, 82h
    532	    02AA  B9 0040		     mov cx, 64
    533	    02AD  51			     push cx
    534	    02AE  56			     push si
    535	    02AF  E8 015C		     call count_no_space_no_zero_letters
    536	    02B2  8B C8			     mov cx, ax
    537	    02B4  BE 0082		     mov si, 82h
    538	    02B7  BF 0545r		     mov di, offset root_folder
    539	    02BA  F3> A4		     rep movsb
    540
    541	    02BC			 parse_args:
    542	    02BC  46			     inc si
    543	    02BD  46			     inc si
    544	    02BE  80 3C	64		     cmp byte ptr [si],	'd'
    545	    02C1  74 07			     je	parse_d
    546	    02C3  80 3C	66		     cmp byte ptr [si],	'f'
    547	    02C6  74 10			     je	parse_f
    548	    02C8  EB 1A			     jmp parse_end
    549	    02CA			 parse_d:
    550					     ;
    551					     ; parse_deep level
    552					     ;
    553	    02CA  46			     inc si
    554	    02CB  46			     inc si
    555	    02CC  8A 1C			     mov bl, byte ptr [si]
    556	    02CE  80 EB	30		     sub bl, 30h	     ; to number
    557	    02D1  88 1E	04DBr		     mov byte ptr [deep_level],	bl
    558	    02D5  46			     inc si
    559	    02D6  EB E4			     jmp parse_args
    560	    02D8			 parse_f:
    561					     ;
    562					     ; parse file extension
    563					     ;
    564	    02D8  46			     inc si
    565	    02D9  46			     inc si
    566	    02DA  BF 04DDr		     mov di, offset file_ext
    567	    02DD  B9 0004		     mov cx, 4
    568	    02E0  F3> A4		     rep movsb
    569	    02E2  EB D8			     jmp parse_args
    570	    02E4			 parse_end:
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 11
2tree.ASM



    571	    02E4  C3			     ret
    572	    02E5			 find_next:
    573	    02E5  B4 4F			     mov ah, 4Fh
    574	    02E7  CD 21			     int 21h
    575
    576	    02E9  C3			     ret
    577
    578	    02EA			 find_first_file:
    579	    02EA  5B			     pop bx
    580	    02EB  5A			     pop dx		; filename spec
    581	    02EC  B9 000F		     mov cx, 0fh	 ; include files
    582	    02EF  53			     push bx
    583
    584	    02F0  33 C0			     xor ax, ax
    585	    02F2  B4 4E			     mov ah, 4Eh
    586	    02F4  CD 21			     int 21h
    587	    02F6  C3			     ret
    588
    589	    02F7			 find_first_folder:
    590	    02F7  5B			     pop bx
    591	    02F8  5A			     pop dx		 ; filename spec
    592	    02F9  B9 0010		     mov cx, 10h	 ; include directories
    593	    02FC  53			     push bx
    594
    595	    02FD  33 C0			     xor ax, ax
    596	    02FF  B4 4E			     mov ah, 4Eh
    597	    0301  CD 21			     int 21h
    598	    0303  C3			     ret
    599
    600	    0304			 is_valid_name:
    601	    0304  5B			     pop bx
    602	    0305  59			     pop cx	 ; deep	level
    603	    0306  53			     push bx
    604
    605	    0307  51			     push cx
    606	    0308  E8 FF46		     call move_dta
    607
    608	    030B  05 001E		     add ax, 1Eh
    609	    030E  8B D8			     mov bx, ax
    610	    0310  B8 0001		     mov ax, 1
    611	    0313  80 3F	2E		     cmp byte ptr [bx],	'.'
    612	    0316  75 03			     jne _is_valid_name_end
    613	    0318  B8 0000		     mov ax, 0
    614	    031B			 _is_valid_name_end:
    615	    031B  C3			     ret
    616
    617	    031C			 show_filename_from_dta:
    618	    031C  5B			     pop bx
    619	    031D  59			     pop cx  ; deep level
    620	    031E  58			     pop ax  ; entity count
    621	    031F  53			     push bx
    622
    623	    0320			 _show_filename_from_dta_valid_name:
    624					     ;
    625					     ;	 pseudo	graphic	prefix
    626					     ;
    627					     load <ax>
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 12
2tree.ASM



2   628	    0320  50				 push ax
    629	    0321  51			     push cx
    630	    0322  E8 FF2C		     call move_dta
    631
    632	    0325  05 001E		     add ax, 1Eh
    633	    0328  8B D8			     mov bx, ax
    634					     restore <ax>
2   635	    032A  58				 pop ax
    636
    637					     load <cx, bx>
2   638	    032B  51				 push cx
2   639	    032C  53				 push bx
    640	    032D  50			     push ax	 ; entity count
    641	    032E  51			     push cx	 ; deep	level
    642	    032F  E8 001E		     call print_pseudographic_prefix
    643					     restore <bx, cx>
2   644	    0332  5B				 pop bx
2   645	    0333  59				 pop cx
    646
    647					     load <bx>
2   648	    0334  53				 push bx
    649	    0335  B9 000D		     mov cx, 13
    650	    0338  51			     push cx
    651	    0339  53			     push bx
    652	    033A  E8 00D1		     call count_no_space_no_zero_letters
    653	    033D  8B C8			     mov cx, ax
    654					     restore <bx>
2   655	    033F  5B				 pop bx
    656	    0340  51			     push cx
    657	    0341  53			     push bx
    658	    0342  E8 00B3		     call print_string_with_length
    659					     print_range <newline>
2   660						 print <offset newline>
3   661	    0345  B4 09				 mov ah, 09h
3   662	    0347  BA 05C5r			 mov dx, offset	newline
3   663	    034A  CD 21				 int 21h
    664	    034C  B8 0001		     mov ax, 1
    665	    034F  C3			     ret
    666	    0350			 print_pseudographic_prefix:
    667	    0350  5B			     pop bx
    668	    0351  59			     pop cx	 ; deep	level
    669	    0352  58			     pop ax	 ; entity count
    670	    0353  53			     push bx
    671
    672	    0354  83 F9	00		     cmp cx, 0
    673	    0357  74 0C			     je	_print_pseudographic_prefix_zero_level
    674					     load <cx, ax>
2   675	    0359  51				 push cx
2   676	    035A  50				 push ax
    677	    035B  B8 04EAr		     mov ax, offset level_shift
    678
    679	    035E  51			     push cx
    680	    035F  50			     push ax
    681	    0360  E8 0095		     call print_string_with_length
    682					     restore <ax, cx>
2   683	    0363  58				 pop ax
2   684	    0364  59				 pop cx
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 13
2tree.ASM



    685	    0365			 _print_pseudographic_prefix_zero_level:
    686
    687	    0365  8B 1E	04D7r		     mov bx, word ptr [current_max_entities]
    688	    0369  3A C3			     cmp al, bl
    689	    036B  74 1E			     je	_print_pseudographic_prefix_zero_level_end
    690	    036D  3D 0001		     cmp ax, 1
    691	    0370  75 10			     jne _print_pseudographic_prefix_zero_level_middle
    692	    0372  83 F9	00		     cmp cx, 0
    693	    0375  74 02			     je	_print_pseudographic_prefix_zero_level_first
    694	    0377  EB 09			     jmp _print_pseudographic_prefix_zero_level_middle
    695	    0379			 _print_pseudographic_prefix_zero_level_first:
    696					     print_range <first_file_char>
2   697						 print <offset first_file_char>
3   698	    0379  B4 09				 mov ah, 09h
3   699	    037B  BA 04FCr			 mov dx, offset	first_file_char
3   700	    037E  CD 21				 int 21h
    701	    0380  EB 12			     jmp _print_pseudographic_prefix_end
    702	    0382			 _print_pseudographic_prefix_zero_level_middle:
    703					     print_range <middle_file_char>
2   704						 print <offset middle_file_char>
3   705	    0382  B4 09				 mov ah, 09h
3   706	    0384  BA 04FEr			 mov dx, offset	middle_file_char
3   707	    0387  CD 21				 int 21h
    708	    0389  EB 09			     jmp _print_pseudographic_prefix_end
    709	    038B			 _print_pseudographic_prefix_zero_level_end:
    710					     print_range <end_file_char>
2   711						 print <offset end_file_char>
3   712	    038B  B4 09				 mov ah, 09h
3   713	    038D  BA 0500r			 mov dx, offset	end_file_char
3   714	    0390  CD 21				 int 21h
    715	    0392  EB 00			     jmp _print_pseudographic_prefix_end
    716	    0394			 _print_pseudographic_prefix_end:
    717	    0394  C3			     ret
    718	    0395			 cd:
    719	    0395  5B			     pop bx ; ret addr
    720	    0396  5A			     pop dx ; root address
    721	    0397  53			     push bx ; ret addr
    722
    723					     load <dx>
2   724	    0398  52				 push dx
    725	    0399  33 C0			     xor ax, ax
    726	    039B  B4 3B			     mov ah, 3Bh
    727	    039D  CD 21			     int 21h
    728
    729	    039F  72 02			     jc	cd_error
    730					     restore <dx>
2   731	    03A1  5A				 pop dx
    732	    03A2  C3			     ret
    733	    03A3			 cd_error:
    734					     print_range <cd_fails, newline>
2   735						 print <offset cd_fails>
3   736	    03A3  B4 09				 mov ah, 09h
3   737	    03A5  BA 0488r			 mov dx, offset	cd_fails
3   738	    03A8  CD 21				 int 21h
2   739						 print <offset newline>
3   740	    03AA  B4 09				 mov ah, 09h
3   741	    03AC  BA 05C5r			 mov dx, offset	newline
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 14
2tree.ASM



3   742	    03AF  CD 21				 int 21h
    743					     restore <dx>
2   744	    03B1  5A				 pop dx
    745
    746	    03B2  B4 09				 mov ah, 09h
    747	    03B4  CD 21			     int 21h
    748
    749					     print_range <newline>
2   750						 print <offset newline>
3   751	    03B6  B4 09				 mov ah, 09h
3   752	    03B8  BA 05C5r			 mov dx, offset	newline
3   753	    03BB  CD 21				 int 21h
    754					     exit
1   755	    03BD  B4 00			     mov ah, 00h
1   756	    03BF  CD 21			     int 21h
    757	    03C1  C3			     ret
    758
    759	    03C2			 set_dta:
    760	    03C2  5B			     pop bx
    761	    03C3  59			     pop cx			 ; deep	level
    762	    03C4  53			     push bx
    763
    764	    03C5  BA 05C7r		     mov dx, offset dta
    765					     load <dx>
2   766	    03C8  52				 push dx
    767	    03C9  33 C0			     xor ax, ax
    768	    03CB  A0 0487r		     mov al, byte ptr [dta_len]
    769	    03CE  F7 E1			     mul cx
    770
    771					     restore <dx>
2   772	    03D0  5A				 pop dx
    773	    03D1  03 D0			     add dx, ax
    774
    775	    03D3  33 C0			     xor ax, ax
    776	    03D5  B4 1A			     mov ah, 1Ah
    777	    03D7  CD 21			     int 21h
    778
    779	    03D9  C3			     ret
    780
    781	    03DA			 save_cwd:
    782	    03DA  BE 0505r		     mov si, offset working_folder
    783
    784					     ;
    785					     ; save driver
    786					     ;
    787	    03DD  B4 19			     mov ah, 19h		 ; GET CURRENT DEFAULT DRIVE
    788	    03DF  CD 21			     int 21h
    789	    03E1  8A D0			     mov dl, al
    790	    03E3  80 C2	41		     add dl, 41h
    791	    03E6  88 14			     mov byte ptr [si],	dl
    792	    03E8  46			     inc si
    793	    03E9  C6 04	3A		     mov byte ptr [si],	':'
    794	    03EC  46			     inc si
    795	    03ED  C6 04	5C		     mov byte ptr [si],	'\'
    796	    03F0  46			     inc si
    797
    798					     ;
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 15
2tree.ASM



    799					     ; save folder
    800					     ;
    801	    03F1  32 D2			     xor dl, dl			 ; Actual drive
    802	    03F3  B4 47			     mov ah, 47h		 ; CWD - GET CURRENT DIRECTORY
    803	    03F5  CD 21			     int 21h
    804	    03F7  C3			     ret
    805	    03F8			 print_string_with_length:
    806	    03F8  5B			     pop bx ; ret address
    807	    03F9  5E			     pop si ; string offset
    808	    03FA  59			     pop cx ; string length
    809	    03FB  53			     push bx; ret address
    810	    03FC  33 C0			     xor ax, ax
    811	    03FE			 _print_string_with_length_loop:
    812	    03FE  B4 02			     mov ah, 02h
    813	    0400  8A 14			     mov dl, byte ptr [si]
    814	    0402  CD 21			     int 21h
    815	    0404  49			     dec cx
    816	    0405  46			     inc si
    817	    0406  83 F9	00		     cmp cx, 00h
    818	    0409  74 02			     je	_print_string_with_length_end
    819	    040B  EB F1			     jmp _print_string_with_length_loop
    820	    040D			 _print_string_with_length_end:
    821	    040D  C3			     ret
    822	    040E			 count_no_space_no_zero_letters:
    823	    040E  5B			     pop bx ; ret address
    824	    040F  5E			     pop si ; string offset
    825	    0410  59			     pop cx ; string length
    826	    0411  53			     push bx ; ret address
    827	    0412  B8 0000		     mov ax, 0
    828	    0415			 _count_non_space_symbols_loop:
    829	    0415  80 3C	20		     cmp byte ptr [si],	20h
    830	    0418  74 12			     je	_count_non_space_symbols_end
    831	    041A  80 3C	0D		     cmp byte ptr [si],	0Dh
    832	    041D  74 0D			     je	_count_non_space_symbols_end
    833	    041F  80 3C	00		     cmp byte ptr [si],	00h
    834	    0422  74 08			     je	_count_non_space_symbols_end
    835	    0424  3B C1			     cmp ax, cx
    836	    0426  74 04			     je	_count_non_space_symbols_end
    837	    0428  40			     inc ax
    838	    0429  46			     inc si
    839	    042A  EB E9			     jmp _count_non_space_symbols_loop
    840	    042C			 _count_non_space_symbols_end:
    841	    042C  C3			     ret
    842	    042D			 count_subfiles_here:
    843	    042D  B8 04DCr		     mov ax, offset file_mask
    844	    0430  BE 02EAr		     mov si, offset find_first_file
    845
    846	    0433  50			     push ax
    847	    0434  56			     push si
    848	    0435  E8 0017		     call count_subfiles_here_by_mask
    849					     load <ax>
2   850	    0438  50				 push ax
    851	    0439  B8 04E2r		     mov ax, offset folder_mask
    852	    043C  BE 02F7r		     mov si, offset find_first_folder
    853
    854	    043F  50			     push ax
    855	    0440  56			     push si
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 16
2tree.ASM



    856	    0441  E8 000B		     call count_subfiles_here_by_mask
    857	    0444  8B D8			     mov bx, ax
    858					     restore <ax>
2   859	    0446  58				 pop ax
    860	    0447  03 D8			     add bx, ax
    861	    0449  8B C3			     mov ax, bx
    862	    044B  A3 04D7r		     mov word ptr [current_max_entities], ax
    863	    044E  C3			     ret
    864	    044F			 count_subfiles_here_by_mask:
    865	    044F  5B			     pop bx
    866	    0450  5E			     pop si		 ; find_first address
    867	    0451  58			     pop ax		 ; mask	address
    868	    0452  53			     push bx
    869
    870					     load <ax, si>
2   871	    0453  50				 push ax
2   872	    0454  56				 push si
    873	    0455  B9 000B		     mov cx, 11		 ; set pointer to count_dta
    874	    0458  51			     push cx
    875	    0459  E8 FF66		     call set_dta
    876					     restore <si, ax>
2   877	    045C  5E				 pop si
2   878	    045D  58				 pop ax
    879
    880	    045E  B9 0000		     mov cx, 0
    881					     load <cx>
2   882	    0461  51				 push cx
    883	    0462  50			     push ax
    884	    0463  FF D6			     call si
    885	    0465  72 1B			     jc	_count_subfiles_from_end
    886	    0467			 _count_subfiles_from_loop:
    887	    0467  B9 000B		     mov cx, 11
    888	    046A  51			     push cx
    889	    046B  E8 FDE3		     call move_dta
    890	    046E  05 001E		     add ax, 1Eh
    891	    0471  8B D8			     mov bx, ax
    892	    0473  80 3F	2E		     cmp byte ptr [bx],	'.'
    893	    0476  74 03			     je	_count_subfiles_from_loop_next
    894
    895					     restore <cx>
2   896	    0478  59				 pop cx
    897	    0479  41			     inc cx
    898					     load <cx>
2   899	    047A  51				 push cx
    900	    047B			 _count_subfiles_from_loop_next:
    901	    047B  E8 FE67		     call find_next
    902	    047E  72 02			     jc	_count_subfiles_from_end
    903
    904	    0480  EB E5			     jmp _count_subfiles_from_loop
    905	    0482			 _count_subfiles_from_end:
    906					     restore <cx>
2   907	    0482  59				 pop cx
    908	    0483  8B C1			     mov ax, cx
    909	    0485  C3			     ret
    910					 ;
    911					 ; error codes
    912					 ;
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 17
2tree.ASM



    913	    0486  12			 no_more_files db 18
    914	    0487  2B			 dta_len db 2bh
    915
    916					 ;
    917					 ; error messages
    918					 ;
    919	    0488  43 68	61 6E 67 65 20+	 cd_fails db 'Change directory fails.$'
    920		  64 69	72 65 63 74 6F+
    921		  72 79	20 66 61 69 6C+
    922		  73 2E	24
    923	    04A0  66 69	6E 64 5F 66 69+	 find_first_fails db 'find_first filenames fails.$'
    924		  72 73	74 20 66 69 6C+
    925		  65 6E	61 6D 65 73 20+
    926		  66 61	69 6C 73 2E 24
    927	    04BC  66 69	6E 64 5F 6E 65+	 find_next_fails db  'find_next	filenames fails.$'
    928		  78 74	20 66 69 6C 65+
    929		  6E 61	6D 65 73 20 66+
    930		  61 69	6C 73 2E 24
    931
    932					 ;
    933					 ; int variables
    934					 ;
    935	    04D7  0000			 current_max_entities dw 0
    936	    04D9  0000			 current_id_entity dw 0
    937
    938					 ;
    939					 ;   parse arguments
    940					 ;
    941	    04DB  01			 deep_level db 1
    942	    04DC  2A			 file_mask db '*'
    943	    04DD  2E 2A	00 00 00	 file_ext db '.*', 00h,	00h, 00h
    944	    04E2  2A 00			 folder_mask db	'*', 00h
    945	    04E4  2A 2E	2A 00		 all_files db '*.*', 00h
    946
    947					 ;
    948					 ;   pseudographic
    949					 ;
    950	    04E8  B3 24			 old_level_shift db 179, '$'
    951	    04EA  0A*(B3) 24		 level_shift db	10 dup(179), '$'
    952	    04F5  ?? 20	24		 space db, 32, '$'
    953
    954	    04F8  C3 24			 zero_first_file db 195, '$'
    955	    04FA  C0 24			 zero_end_file db 192, '$'
    956
    957	    04FC  C2 24			 first_file_char db 194, '$'
    958	    04FE  C3 24			 middle_file_char db 195, '$'
    959	    0500  C0 24			 end_file_char db 192, '$'
    960
    961					 ;
    962					 ; strings
    963					 ;
    964	    0502  2E 2E	00		 parent_folder db '..',	00h
    965	    0505  40*(00)		 working_folder	db 64 dup(00h)
    966	    0545  40*(00)		 root_folder db	64 dup(00h)
    967	    0585  40*(00)		 start_mask db 64 dup(00h)
    968	    05C5  0A 24			 newline db 0Ah, '$'
    969	    05C7  10CC*(00)		 dta db	4300 dup(0)
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 18
2tree.ASM



    970	    1693  2B*(00)		 count_dta db 43 dup(0)
    971					 end start
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 19
Symbol Table




Symbol Name			  Type	 Value

??DATE				  Text	 "12/10/19"
??FILENAME			  Text	 "2tree	  "
??TIME				  Text	 "14:05:14"
??VERSION			  Number 040A
@32BIT				  Text	 0
@CODE				  Text	 DGROUP
@CODESIZE			  Text	 0
@CPU				  Text	 0F0FH
@CURSEG				  Text	 _TEXT
@DATA				  Text	 DGROUP
@DATASIZE			  Text	 0
@FILENAME			  Text	 2TREE
@INTERFACE			  Text	 000H
@MODEL				  Text	 1
@STACK				  Text	 DGROUP
@WORDSIZE			  Text	 2
ALL_FILES			  Byte	 DGROUP:04E4
CD				  Near	 DGROUP:0395
CD_ERROR			  Near	 DGROUP:03A3
CD_FAILS			  Byte	 DGROUP:0488
COUNT_DTA			  Byte	 DGROUP:1693
COUNT_NO_SPACE_NO_ZERO_LETTERS	  Near	 DGROUP:040E
COUNT_SUBFILES_HERE		  Near	 DGROUP:042D
COUNT_SUBFILES_HERE_BY_MASK	  Near	 DGROUP:044F
CURRENT_ID_ENTITY		  Word	 DGROUP:04D9
CURRENT_MAX_ENTITIES		  Word	 DGROUP:04D7
DEEP_LEVEL			  Byte	 DGROUP:04DB
DTA				  Byte	 DGROUP:05C7
DTA_LEN				  Byte	 DGROUP:0487
END_FILE_CHAR			  Byte	 DGROUP:0500
FILE_EXT			  Byte	 DGROUP:04DD
FILE_MASK			  Byte	 DGROUP:04DC
FIND_FIRST_ERROR		  Near	 DGROUP:0286
FIND_FIRST_FAILS		  Byte	 DGROUP:04A0
FIND_FIRST_FILE			  Near	 DGROUP:02EA
FIND_FIRST_FOLDER		  Near	 DGROUP:02F7
FIND_NEXT			  Near	 DGROUP:02E5
FIND_NEXT_ERROR			  Near	 DGROUP:0295
FIND_NEXT_FAILS			  Byte	 DGROUP:04BC
FIRST_FILE_CHAR			  Byte	 DGROUP:04FC
FOLDER_MASK			  Byte	 DGROUP:04E2
IS_FOLDER			  Near	 DGROUP:0263
IS_VALID_NAME			  Near	 DGROUP:0304
LEVEL_SHIFT			  Byte	 DGROUP:04EA
LIST_SUBFILES_RECURSIVE		  Near	 DGROUP:0163
LIST_SUBFILES_RECURSIVE_FROM	  Near	 DGROUP:0135
MIDDLE_FILE_CHAR		  Byte	 DGROUP:04FE
MOVE_DTA			  Near	 DGROUP:0251
NEWLINE				  Byte	 DGROUP:05C5
NO_MORE_FILES			  Byte	 DGROUP:0486
OLD_LEVEL_SHIFT			  Byte	 DGROUP:04E8
PARENT_FOLDER			  Byte	 DGROUP:0502
PARSE_ARGS			  Near	 DGROUP:02BC
PARSE_COMMAND_LINE		  Near	 DGROUP:02A7
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 20
Symbol Table



PARSE_D				  Near	 DGROUP:02CA
PARSE_END			  Near	 DGROUP:02E4
PARSE_F				  Near	 DGROUP:02D8
PRINT_PSEUDOGRAPHIC_PREFIX	  Near	 DGROUP:0350
PRINT_STRING_WITH_LENGTH	  Near	 DGROUP:03F8
ROOT_FOLDER			  Byte	 DGROUP:0545
SAVE_CWD			  Near	 DGROUP:03DA
SET_DTA				  Near	 DGROUP:03C2
SHOW_FILENAME_FROM_DTA		  Near	 DGROUP:031C
SPACE				  Byte	 DGROUP:04F5
START				  Near	 DGROUP:0100
START_MASK			  Byte	 DGROUP:0585
WORKING_FOLDER			  Byte	 DGROUP:0505
ZERO_END_FILE			  Byte	 DGROUP:04FA
ZERO_FIRST_FILE			  Byte	 DGROUP:04F8
_COUNT_NON_SPACE_SYMBOLS_END	  Near	 DGROUP:042C
_COUNT_NON_SPACE_SYMBOLS_LOOP	  Near	 DGROUP:0415
_COUNT_SUBFILES_FROM_END	  Near	 DGROUP:0482
_COUNT_SUBFILES_FROM_LOOP	  Near	 DGROUP:0467
_COUNT_SUBFILES_FROM_LOOP_NEXT	  Near	 DGROUP:047B
_IS_FOLDER_END			  Near	 DGROUP:0285
_IS_FOLDER_FALSE		  Near	 DGROUP:0280
_IS_FOLDER_TRUE			  Near	 DGROUP:027B
_IS_VALID_NAME_END		  Near	 DGROUP:031B
_LIST_SUBFILES_RECURSIVE_END	  Near	 DGROUP:024C
_LIST_SUBFILES_RECURSIVE_LOOP	  Near	 DGROUP:0185
_LIST_SUBFILES_RECURSIVE_LOOP_PS  Near	 DGROUP:01CB
EUDOGRAPHIC_HACK
_LIST_SUBFILES_RECURSIVE_NEXT	  Near	 DGROUP:023F
_PRINT_PSEUDOGRAPHIC_PREFIX_END	  Near	 DGROUP:0394
_PRINT_PSEUDOGRAPHIC_PREFIX_ZERO  Near	 DGROUP:0365
_LEVEL
_PRINT_PSEUDOGRAPHIC_PREFIX_ZERO  Near	 DGROUP:038B
_LEVEL_END
_PRINT_PSEUDOGRAPHIC_PREFIX_ZERO  Near	 DGROUP:0379
_LEVEL_FIRST
_PRINT_PSEUDOGRAPHIC_PREFIX_ZERO  Near	 DGROUP:0382
_LEVEL_MIDDLE
_PRINT_STRING_WITH_LENGTH_END	  Near	 DGROUP:040D
_PRINT_STRING_WITH_LENGTH_LOOP	  Near	 DGROUP:03FE
_SHOW_FILENAME_FROM_DTA_VALID_NA  Near	 DGROUP:0320
ME

Macro Name

BREAK_POINT
CLEAR_MES
EXIT
GET_OFFSET
GET_TRANSITION
LOAD
PRINT
PRINT_RANGE
PUT
RESTORE
SET_TRANSITION
SET_TRANSITION_FOR_ALL
Turbo Assembler	 Version 4.1	    12/10/19 14:05:15	    Page 21
Symbol Table



SET_TRANSITION_FOR_DIGITS
SET_TRANSITION_FOR_LETTERS
SET_TRANSITION_LENGTH_FROM_START
SET_ZERO
TO_NON_SPACE

Groups & Segments		  Bit Size Align  Combine Class

DGROUP				  Group
  _DATA				  16  0000 Word	  Public  DATA
  _TEXT				  16  16BE Word	  Public  CODE
