Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 1
2tree.ASM



      1					 include macro.asm
1     2					 load macro args
1     3					     irp d,<args>
1     4						 push d
1     5					     endm
1     6					 endm
1     7
1     8					 restore macro args
1     9					     irp d,<args>
1    10						 pop d
1    11					     endm
1    12					 endm
1    13
1    14					 exit macro
1    15					     mov ah, 00h
1    16					     int 21h
1    17					 endm
1    18
1    19					 print macro buf
1    20						 mov ah, 09h
1    21						 mov dx, buf
1    22						 int 21h
1    23					 endm
1    24
1    25					 print_range macro args
1    26					     irp d,<args>
1    27						 print <offset d>
1    28					     endm
1    29					 endm
1    30
1    31					 break_point macro arg
1    32					     load <arg>
1    33					     xor arg, arg
1    34					     xor arg, arg
1    35					     xor arg, arg
1    36					     xor arg, arg
1    37					     xor arg, arg
1    38					     xor arg, arg
1    39					     xor arg, arg
1    40					     xor arg, arg
1    41					     restore <arg>
1    42					 endm
1    43
1    44					 get_offset macro state
1    45					     xor dx, dx
1    46					     xor ax, ax
1    47					     mov al, state
1    48					     shl ax, 8
1    49					 endm get_offset
1    50
1    51					 to_non_space macro addr
1    52					     local l1, l2
1    53					     mov si, addr
1    54					 l1:
1    55					     mov byte ptr al, [si]
1    56					     cmp al, 20h
1    57					     je	l2
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 2
2tree.ASM



1    58					     cmp al, 0
1    59					     je	l2
1    60					     inc si
1    61					     jmp l1
1    62					 l2:
1    63					     inc si
1    64					     mov ax, si
1    65					 endm
1    66
1    67					 set_transition	macro buf, from, to, char
1    68					     load<bx, dx>
1    69					     get_offset	from
1    70
1    71					     add ax, offset buf
1    72					     add ax, char
1    73
1    74					     mov bx, ax
1    75					     mov byte ptr [bx],	to
1    76					     restore<dx, bx>
1    77					 endm
1    78
1    79					 set_transition_length_from_start macro	buf, from, to, start, iterations
1    80					     local l1, end
1    81					     mov bx, start
1    82					     mov cx, iterations
1    83					 l1:
1    84					     cmp cx, 0
1    85					     je	end
1    86
1    87					     load <bx,cx>
1    88					     set_transition buf	from to	bx
1    89					     restore <cx,bx>
1    90
1    91					     inc bx
1    92					     dec cx
1    93					     jmp l1
1    94					 end:
1    95					 endm
1    96
1    97					 set_zero macro	state
1    98					     mov al, 0
1    99					     mov byte ptr [state], al
1   100					 endm
1   101
1   102					 set_transition_for_all	macro buf, from, to
1   103					     set_transition_length_from_start buf, from, to, 0,	255
1   104					 endm
1   105
1   106					 set_transition_for_digits macro buf, from, to
1   107					     set_transition_length_from_start buf, from, to, 30, 10
1   108					 endm
1   109
1   110					 set_transition_for_letters macro buf, from, to
1   111					     set_transition_length_from_start buf, from, to, 97, 26
1   112					     set_transition_length_from_start buf, from, to, 65, 26
1   113					 endm
1   114
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 3
2tree.ASM



1   115					 get_transition	macro buf, from, char
1   116					     load <dx>
1   117					     get_offset	from
1   118					     restore <dx>
1   119
1   120					     add ax, offset buf
1   121					     add ax, char
1   122
1   123					     mov bx, ax
1   124					     xor ax, ax
1   125					     mov al, byte ptr [bx]
1   126					 endm
1   127
1   128					 put macro from, to, position
1   129					     xor dx, dx
1   130					     xor bx, bx
1   131
1   132					     mov dx, offset to
1   133					     mov bl, byte ptr [position]
1   134					     add dx, bx
1   135
1   136					     mov bl, byte ptr [from]
1   137					     mov byte ptr [edx], bl
1   138					     inc [position]
1   139					 endm
1   140
1   141					 clear_mes macro mes, lastidx
1   142					     local l1, end
1   143					     mov bx, offset mes
1   144					     mov cl, byte ptr [lastidx]
1   145					     inc cl
1   146					 l1:
1   147					     cmp cl, 0
1   148					     je	end
1   149					     mov byte ptr [bx],	'$'
1   150					     inc bx
1   151					     dec cl
1   152					     jmp l1
1   153					 end:
1   154					     mov bl, 0
1   155					     mov byte ptr [lastidx], bl
1   156					 endm
    157
    158	    0000			 model tiny
    159					 .386
    160	    0000			 .code
    161					 org 100h
    162	    0100			 start:
    163	    0100  E8 0256		     call save_cwd
    164	    0103  B9 0000		     mov cx, 0
    165	    0106  51			     push cx
    166	    0107  E8 0237		     call set_dta
    167	    010A  E8 011F		     call parse_command_line
    168
    169					     ;
    170					     ;	 start tree
    171					     ;
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 4
2tree.ASM



    172	    010D  B8 04AFr		     mov ax, offset root_folder
    173	    0110  B9 0000		     mov cx, 0
    174	    0113  51			     push cx
    175	    0114  50			     push ax
    176	    0115  E8 000B		     call list_subfiles_recursive_from
    177
    178					     ;
    179					     ;	 cd to start folder
    180					     ;
    181	    0118  B8 046Fr		     mov ax, offset working_folder
    182	    011B  50			     push ax
    183	    011C  E8 0207		     call cd
    184					     exit
1   185	    011F  B4 00			     mov ah, 00h
1   186	    0121  CD 21			     int 21h
    187
    188	    0123			 list_subfiles_recursive_from:
    189	    0123  5B			     pop bx	 ; ret address
    190	    0124  58			     pop ax	 ; deep	level
    191	    0125  59			     pop cx	 ; root	folder offset
    192	    0126  53			     push bx
    193					     load <cx>
2   194	    0127  51				 push cx
    195	    0128  50			     push ax
    196	    0129  E8 01FA		     call cd
    197					     restore <cx>
2   198	    012C  59				 pop cx
    199
    200					     ;
    201					     ; list subfolder
    202					     ;
    203	    012D  BB 0000		     mov bx, 0
    204	    0130  B8 0457r		     mov ax, offset folder_mask
    205					     load <cx>
2   206	    0133  51				 push cx
    207	    0134  53			     push bx
    208	    0135  50			     push ax
    209	    0136  51			     push cx
    210	    0137  E8 000F		     call list_subfiles_recursive
    211					     restore <cx>
2   212	    013A  59				 pop cx
    213
    214					     ;
    215					     ; list files
    216					     ;
    217	    013B  8B D8			     mov bx, ax
    218	    013D  B8 0451r		     mov ax, offset file_mask
    219					     load <cx>
2   220	    0140  51				 push cx
    221	    0141  53			     push bx
    222	    0142  50			     push ax
    223	    0143  51			     push cx
    224	    0144  E8 0002		     call list_subfiles_recursive
    225					     restore <cx>
2   226	    0147  59				 pop cx
    227	    0148  C3			     ret
    228
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 5
2tree.ASM



    229	    0149			 list_subfiles_recursive:
    230					     ;
    231					     ;	 save current files
    232					     ;
    233	    0149  E8 0260		     call count_subfiles_here
    234	    014C  A3 044Cr		     mov word ptr [current_max_entities], ax
    235					     ; break_point <bx>
    236
    237	    014F  5A			     pop dx
    238	    0150  59			     pop cx ; deep level
    239	    0151  58			     pop ax ; filemask offset
    240	    0152  5B			     pop bx ; current index
    241	    0153  52			     push dx
    242
    243					     load <cx, ax, bx>
2   244	    0154  51				 push cx
2   245	    0155  50				 push ax
2   246	    0156  53				 push bx
    247	    0157  51			     push cx
    248	    0158  E8 01E6		     call set_dta
    249					     restore <bx, ax, cx>
2   250	    015B  5B				 pop bx
2   251	    015C  58				 pop ax
2   252	    015D  59				 pop cx
    253
    254					     ; mov bx, word ptr	[current_id_entity]
    255					     load <bx, cx>
2   256	    015E  53				 push bx
2   257	    015F  51				 push cx
    258	    0160  50			     push ax
    259	    0161  E8 010A		     call find_first
    260	    0164  73 05			     jnc _list_subfiles_recursive_loop
    261	    0166  E8 00A2		     call find_first_error
    262	    0169  EB 72			     jmp _list_subfiles_recursive_end
    263	    016B			 _list_subfiles_recursive_loop:
    264					     restore <cx>
2   265	    016B  59				 pop cx
    266	    016C  51			     push cx
    267	    016D  E8 010B		     call is_valid_name
    268					     load <cx>
2   269	    0170  51				 push cx
    270	    0171  3D 0001		     cmp ax, 1
    271	    0174  75 5C			     jne _list_subfiles_recursive_next
    272
    273					     restore <cx, bx>
2   274	    0176  59				 pop cx
2   275	    0177  5B				 pop bx
    276	    0178  43			     inc bx
    277					     load <bx, cx>
2   278	    0179  53				 push bx
2   279	    017A  51				 push cx
    280	    017B  53			     push bx
    281	    017C  51			     push cx
    282					     ; break_point <ax>
    283	    017D  E8 0113		     call show_filename_from_dta
    284					     ; cmp ax, 1
    285					     ; jne _list_subfiles_recursive_next
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 6
2tree.ASM



    286
    287					     ;
    288					     ;	 check if folder
    289					     ;
    290	    0180  E8 0071		     call is_folder
    291	    0183  3D 0001		     cmp ax, 1
    292	    0186  75 4A			     jne _list_subfiles_recursive_next
    293
    294					     ;
    295					     ;	 check deep level
    296					     ;
    297					     restore <cx>
2   298	    0188  59				 pop cx
    299					     load <cx>
2   300	    0189  51				 push cx
    301	    018A  33 DB			     xor bx, bx
    302	    018C  8A 1E	0450r		     mov bl, byte ptr [deep_level]
    303	    0190  3B CB			     cmp cx, bx
    304	    0192  7D 3E			     jge _list_subfiles_recursive_next
    305
    306					     ;
    307					     ; start new search
    308					     ;
    309	    0194  A1 044Cr		     mov ax, word ptr [current_max_entities]
    310					     load <ax>
2   311	    0197  50				 push ax
    312					     ;
    313					     ;	 cd to subfolder
    314					     ;
    315					     load <cx>
2   316	    0198  51				 push cx
    317	    0199  51			     push cx
    318	    019A  E8 0045		     call move_dta
    319	    019D  05 001E		     add ax, 1Eh
    320
    321	    01A0  50			     push ax
    322	    01A1  E8 0182		     call cd
    323					     restore <cx>
2   324	    01A4  59				 pop cx
    325
    326	    01A5  41			     inc cx
    327					     ;
    328					     ;	 list subfiles from subfolder
    329					     ;
    330					     load <cx>
2   331	    01A6  51				 push cx
    332	    01A7  BB 0000		     mov bx, 0
    333					     ; sub bx, 0Bh
    334					     ; mov bx, word ptr	[bx]
    335	    01AA  B8 0457r		     mov ax, offset folder_mask
    336					     ; break_point <bx>
    337	    01AD  53			     push bx
    338	    01AE  50			     push ax
    339	    01AF  51			     push cx
    340	    01B0  E8 FF96		     call list_subfiles_recursive
    341					     restore <cx>
2   342	    01B3  59				 pop cx
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 7
2tree.ASM



    343
    344
    345					     ;
    346					     ;	 list subfolders from subfolder
    347					     ;
    348					     load <cx>
2   349	    01B4  51				 push cx
    350	    01B5  8B D8			     mov bx, ax
    351					     ; sub bx, 0Bh
    352					     ; mov bx, word ptr	[bx]
    353	    01B7  B8 0451r		     mov ax, offset file_mask
    354	    01BA  53			     push bx
    355	    01BB  50			     push ax
    356	    01BC  51			     push cx
    357	    01BD  E8 FF89		     call list_subfiles_recursive
    358					     restore <cx>
2   359	    01C0  59				 pop cx
    360
    361					     ;
    362					     ;	 cd back to this function
    363					     ;
    364	    01C1  B8 046Cr		     mov ax, offset parent_folder
    365	    01C4  50			     push ax
    366	    01C5  E8 015E		     call cd
    367
    368					     ; break_point <ax>
    369					     restore <ax>
2   370	    01C8  58				 pop ax
    371	    01C9  A3 044Cr		     mov word ptr [current_max_entities], ax
    372
    373					     restore <cx>
2   374	    01CC  59				 pop cx
    375					     load <cx>
2   376	    01CD  51				 push cx
    377	    01CE  51			     push cx
    378	    01CF  E8 016F		     call set_dta
    379	    01D2			 _list_subfiles_recursive_next:
    380	    01D2  E8 0094		     call find_next
    381	    01D5  73 94			     jnc _list_subfiles_recursive_loop
    382	    01D7  3A 06	03FBr		     cmp al, byte ptr [no_more_files]
    383	    01DB  75 3D			     jne find_next_error
    384	    01DD			 _list_subfiles_recursive_end:
    385					     restore <cx, bx>
2   386	    01DD  59				 pop cx
2   387	    01DE  5B				 pop bx
    388	    01DF  8B C3			     mov ax, bx
    389	    01E1  C3			     ret
    390	    01E2			 move_dta:
    391	    01E2  5B			     pop bx
    392	    01E3  59			     pop cx
    393	    01E4  53			     push bx
    394
    395	    01E5  33 C0			     xor ax, ax
    396	    01E7  A0 03FCr		     mov al, byte ptr [dta_len]
    397	    01EA  F7 E1			     mul cx
    398
    399	    01EC  BB 0531r		     mov bx, offset dta
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 8
2tree.ASM



    400	    01EF  03 D8			     add bx, ax
    401	    01F1  8B C3			     mov ax, bx
    402	    01F3  C3			     ret
    403	    01F4			 is_folder:
    404	    01F4  BB 0546r		     mov bx, offset dta	+ 15h
    405	    01F7  8A 1F			     mov bl, byte ptr [bx]
    406	    01F9  80 FB	10		     cmp bl, 10h
    407	    01FC  74 02			     je	_is_folder_true
    408	    01FE  75 05			     jne _is_folder_false
    409	    0200			 _is_folder_true:
    410	    0200  B8 0001		     mov ax, 1
    411	    0203  EB 05			     jmp _is_folder_end
    412	    0205			 _is_folder_false:
    413	    0205  B8 0000		     mov ax, 0
    414	    0208  EB 00			     jmp _is_folder_end
    415	    020A			 _is_folder_end:
    416	    020A  C3			     ret
    417
    418	    020B			 find_first_error:
    419					     print_range <find_first_fails, newline>
2   420						 print <offset find_first_fails>
3   421	    020B  B4 09				 mov ah, 09h
3   422	    020D  BA 0415r			 mov dx, offset	find_first_fails
3   423	    0210  CD 21				 int 21h
2   424						 print <offset newline>
3   425	    0212  B4 09				 mov ah, 09h
3   426	    0214  BA 052Fr			 mov dx, offset	newline
3   427	    0217  CD 21				 int 21h
    428	    0219  C3			     ret
    429	    021A			 find_next_error:
    430					     print_range <find_next_fails, newline>
2   431						 print <offset find_next_fails>
3   432	    021A  B4 09				 mov ah, 09h
3   433	    021C  BA 0431r			 mov dx, offset	find_next_fails
3   434	    021F  CD 21				 int 21h
2   435						 print <offset newline>
3   436	    0221  B4 09				 mov ah, 09h
3   437	    0223  BA 052Fr			 mov dx, offset	newline
3   438	    0226  CD 21				 int 21h
    439					     exit
1   440	    0228  B4 00			     mov ah, 00h
1   441	    022A  CD 21			     int 21h
    442
    443	    022C			 parse_command_line:
    444					     ;
    445					     ; prepare root folder
    446					     ;
    447	    022C  BE 0082		     mov si, 82h
    448	    022F  B9 0040		     mov cx, 64
    449	    0232  51			     push cx
    450	    0233  56			     push si
    451	    0234  E8 0156		     call count_no_space_no_zero_letters
    452	    0237  8B C8			     mov cx, ax
    453	    0239  BE 0082		     mov si, 82h
    454	    023C  BF 04AFr		     mov di, offset root_folder
    455	    023F  F3> A4		     rep movsb
    456
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 9
2tree.ASM



    457	    0241			 parse_args:
    458	    0241  46			     inc si
    459	    0242  46			     inc si
    460	    0243  80 3C	64		     cmp byte ptr [si],	'd'
    461	    0246  74 07			     je	parse_d
    462	    0248  80 3C	66		     cmp byte ptr [si],	'f'
    463	    024B  74 0F			     je	parse_f
    464	    024D  EB 19			     jmp parse_end
    465	    024F			 parse_d:
    466					     ;
    467					     ; parse_deep level
    468					     ;
    469	    024F  46			     inc si
    470	    0250  46			     inc si
    471	    0251  8A 1C			     mov bl, byte ptr [si]
    472	    0253  80 EB	30		     sub bl, 30h	     ; to number
    473	    0256  88 1E	0450r		     mov byte ptr [deep_level],	bl
    474	    025A  EB E5			     jmp parse_args
    475	    025C			 parse_f:
    476					     ;
    477					     ; parse file extension
    478					     ;
    479	    025C  46			     inc si
    480	    025D  46			     inc si
    481	    025E  BF 0452r		     mov di, offset file_ext
    482	    0261  B9 0004		     mov cx, 4
    483	    0264  F3> A4		     rep movsb
    484	    0266  EB D9			     jmp parse_args
    485	    0268			 parse_end:
    486	    0268  C3			     ret
    487	    0269			 find_next:
    488	    0269  B4 4F			     mov ah, 4Fh
    489	    026B  CD 21			     int 21h
    490
    491	    026D  C3			     ret
    492
    493	    026E			 find_first:
    494	    026E  5B			     pop bx
    495	    026F  5A			     pop dx		 ; filename spec
    496	    0270  B9 0010		     mov cx, 10h	 ; include directories
    497	    0273  53			     push bx
    498
    499	    0274  33 C0			     xor ax, ax
    500	    0276  B4 4E			     mov ah, 4Eh
    501	    0278  CD 21			     int 21h
    502	    027A  C3			     ret
    503
    504	    027B			 is_valid_name:
    505	    027B  5B			     pop bx
    506	    027C  59			     pop cx	 ; deep	level
    507	    027D  53			     push bx
    508
    509	    027E  51			     push cx
    510	    027F  E8 FF60		     call move_dta
    511
    512	    0282  05 001E		     add ax, 1Eh
    513	    0285  8B D8			     mov bx, ax
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 10
2tree.ASM



    514	    0287  B8 0001		     mov ax, 1
    515	    028A  80 3F	2E		     cmp byte ptr [bx],	'.'
    516	    028D  75 03			     jne _is_valid_name_end
    517	    028F  B8 0000		     mov ax, 0
    518	    0292			 _is_valid_name_end:
    519	    0292  C3			     ret
    520
    521	    0293			 show_filename_from_dta:
    522	    0293  5B			     pop bx
    523	    0294  59			     pop cx  ; deep level
    524	    0295  58			     pop ax  ; entity count
    525	    0296  53			     push bx
    526
    527					     ; load <ax, cx>
    528					     ; push cx
    529					     ; call is_valid_name
    530					     ; cmp ax, 1
    531					     ; je _show_filename_from_dta_valid_name
    532					     ; restore <cx, ax>
    533					     ; mov ax, 0
    534					     ; ret
    535	    0297			 _show_filename_from_dta_valid_name:
    536					     ;
    537					     ;	 pseudo	graphic	prefix
    538					     ;
    539					     load <ax>
2   540	    0297  50				 push ax
    541	    0298  51			     push cx
    542	    0299  E8 FF46		     call move_dta
    543
    544	    029C  05 001E		     add ax, 1Eh
    545	    029F  8B D8			     mov bx, ax
    546					     restore <ax>
2   547	    02A1  58				 pop ax
    548					     ; break_point <dx>
    549					     ; restore <cx, ax>
    550
    551					     load <cx, bx>
2   552	    02A2  51				 push cx
2   553	    02A3  53				 push bx
    554	    02A4  50			     push ax	 ; entity count
    555	    02A5  51			     push cx	 ; deep	level
    556	    02A6  E8 001E		     call print_pseudographic_prefix
    557					     restore <bx, cx>
2   558	    02A9  5B				 pop bx
2   559	    02AA  59				 pop cx
    560
    561					     load <bx>
2   562	    02AB  53				 push bx
    563	    02AC  B9 000D		     mov cx, 13
    564	    02AF  51			     push cx
    565	    02B0  53			     push bx
    566	    02B1  E8 00D9		     call count_no_space_no_zero_letters
    567	    02B4  8B C8			     mov cx, ax
    568					     restore <bx>
2   569	    02B6  5B				 pop bx
    570					     ; mov ax, offset dta + 1Eh
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 11
2tree.ASM



    571	    02B7  51			     push cx
    572	    02B8  53			     push bx
    573	    02B9  E8 00BB		     call print_string_with_length
    574					     print_range <newline>
2   575						 print <offset newline>
3   576	    02BC  B4 09				 mov ah, 09h
3   577	    02BE  BA 052Fr			 mov dx, offset	newline
3   578	    02C1  CD 21				 int 21h
    579	    02C3  B8 0001		     mov ax, 1
    580	    02C6  C3			     ret
    581	    02C7			 print_pseudographic_prefix:
    582	    02C7  5B			     pop bx
    583	    02C8  59			     pop cx	 ; deep	level
    584	    02C9  58			     pop ax	 ; entity count
    585	    02CA  53			     push bx
    586
    587	    02CB  83 F9	00		     cmp cx, 0
    588	    02CE  74 19			     je	_print_pseudographic_prefix_zero_level
    589					     print_range <level_shift>
2   590						 print <offset level_shift>
3   591	    02D0  B4 09				 mov ah, 09h
3   592	    02D2  BA 045Dr			 mov dx, offset	level_shift
3   593	    02D5  CD 21				 int 21h
    594	    02D7  49			     dec cx
    595	    02D8  83 F9	00		     cmp cx, 0
    596	    02DB  74 0C			     je	_print_pseudographic_prefix_zero_level
    597	    02DD			 _print_pseudographic_prefix_loop:
    598					     print_range <space>
2   599						 print <offset space>
3   600	    02DD  B4 09				 mov ah, 09h
3   601	    02DF  BA 045Fr			 mov dx, offset	space
3   602	    02E2  CD 21				 int 21h
    603	    02E4  49			     dec cx
    604	    02E5  0F 85	0094		     jnz _print_string_with_length_loop
    605	    02E9			 _print_pseudographic_prefix_zero_level:
    606					     break_point <dx>
1   607					     load <dx>
3   608	    02E9  52				 push dx
1   609	    02EA  33 D2			     xor dx, dx
1   610	    02EC  33 D2			     xor dx, dx
1   611	    02EE  33 D2			     xor dx, dx
1   612	    02F0  33 D2			     xor dx, dx
1   613	    02F2  33 D2			     xor dx, dx
1   614	    02F4  33 D2			     xor dx, dx
1   615	    02F6  33 D2			     xor dx, dx
1   616	    02F8  33 D2			     xor dx, dx
1   617					     restore <dx>
3   618	    02FA  5A				 pop dx
    619
    620	    02FB  8B 1E	044Cr		     mov bx, word ptr [current_max_entities]
    621	    02FF  3A C3			     cmp al, bl
    622	    0301  74 19			     je	_print_pseudographic_prefix_zero_level_end
    623	    0303  3D 0001		     cmp ax, 1
    624	    0306  74 02			     je	_print_pseudographic_prefix_zero_level_first
    625	    0308  EB 09			     jmp _print_pseudographic_prefix_zero_level_middle
    626	    030A			 _print_pseudographic_prefix_zero_level_first:
    627					     print_range <first_file_char>
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 12
2tree.ASM



2   628						 print <offset first_file_char>
3   629	    030A  B4 09				 mov ah, 09h
3   630	    030C  BA 0466r			 mov dx, offset	first_file_char
3   631	    030F  CD 21				 int 21h
    632	    0311  EB 12			     jmp _print_pseudographic_prefix_end
    633	    0313			 _print_pseudographic_prefix_zero_level_middle:
    634					     print_range <middle_file_char>
2   635						 print <offset middle_file_char>
3   636	    0313  B4 09				 mov ah, 09h
3   637	    0315  BA 0468r			 mov dx, offset	middle_file_char
3   638	    0318  CD 21				 int 21h
    639	    031A  EB 09			     jmp _print_pseudographic_prefix_end
    640	    031C			 _print_pseudographic_prefix_zero_level_end:
    641					     print_range <end_file_char>
2   642						 print <offset end_file_char>
3   643	    031C  B4 09				 mov ah, 09h
3   644	    031E  BA 046Ar			 mov dx, offset	end_file_char
3   645	    0321  CD 21				 int 21h
    646	    0323  EB 00			     jmp _print_pseudographic_prefix_end
    647	    0325			 _print_pseudographic_prefix_end:
    648	    0325  C3			     ret
    649	    0326			 cd:
    650	    0326  5B			     pop bx ; ret addr
    651	    0327  5A			     pop dx ; root address
    652	    0328  53			     push bx ; ret addr
    653
    654	    0329  33 C0			     xor ax, ax
    655	    032B  B4 3B			     mov ah, 3Bh
    656	    032D  CD 21			     int 21h
    657
    658	    032F  72 01			     jc	cd_error
    659	    0331  C3			     ret
    660	    0332			 cd_error:
    661					     print_range <cd_fails, newline>
2   662						 print <offset cd_fails>
3   663	    0332  B4 09				 mov ah, 09h
3   664	    0334  BA 03FDr			 mov dx, offset	cd_fails
3   665	    0337  CD 21				 int 21h
2   666						 print <offset newline>
3   667	    0339  B4 09				 mov ah, 09h
3   668	    033B  BA 052Fr			 mov dx, offset	newline
3   669	    033E  CD 21				 int 21h
    670	    0340  C3			     ret
    671
    672	    0341			 set_dta:
    673	    0341  5B			     pop bx
    674	    0342  59			     pop cx			 ; deep	level
    675	    0343  53			     push bx
    676
    677	    0344  BA 0531r		     mov dx, offset dta
    678					     load <dx>
2   679	    0347  52				 push dx
    680	    0348  33 C0			     xor ax, ax
    681	    034A  A0 03FCr		     mov al, byte ptr [dta_len]
    682	    034D  F7 E1			     mul cx
    683
    684					     restore <dx>
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 13
2tree.ASM



2   685	    034F  5A				 pop dx
    686	    0350  03 D0			     add dx, ax
    687
    688	    0352  33 C0			     xor ax, ax
    689	    0354  B4 1A			     mov ah, 1Ah
    690	    0356  CD 21			     int 21h
    691
    692	    0358  C3			     ret
    693
    694	    0359			 save_cwd:
    695	    0359  BE 046Fr		     mov si, offset working_folder
    696
    697					     ;
    698					     ; save driver
    699					     ;
    700	    035C  B4 19			     mov ah, 19h		 ; GET CURRENT DEFAULT DRIVE
    701	    035E  CD 21			     int 21h
    702	    0360  8A D0			     mov dl, al
    703	    0362  80 C2	41		     add dl, 41h
    704	    0365  88 14			     mov byte ptr [si],	dl
    705	    0367  46			     inc si
    706	    0368  C6 04	3A		     mov byte ptr [si],	':'
    707	    036B  46			     inc si
    708	    036C  C6 04	5C		     mov byte ptr [si],	'\'
    709	    036F  46			     inc si
    710
    711					     ;
    712					     ; save folder
    713					     ;
    714	    0370  32 D2			     xor dl, dl			 ; Actual drive
    715	    0372  B4 47			     mov ah, 47h		 ; CWD - GET CURRENT DIRECTORY
    716	    0374  CD 21			     int 21h
    717	    0376  C3			     ret
    718	    0377			 print_string_with_length:
    719	    0377  5B			     pop bx ; ret address
    720	    0378  5E			     pop si ; string offset
    721	    0379  59			     pop cx ; string length
    722	    037A  53			     push bx; ret address
    723	    037B  33 C0			     xor ax, ax
    724	    037D			 _print_string_with_length_loop:
    725	    037D  B4 02			     mov ah, 02h
    726	    037F  8A 14			     mov dl, byte ptr [si]
    727	    0381  CD 21			     int 21h
    728	    0383  49			     dec cx
    729	    0384  46			     inc si
    730	    0385  83 F9	00		     cmp cx, 00h
    731	    0388  74 02			     je	_print_string_with_length_end
    732	    038A  EB F1			     jmp _print_string_with_length_loop
    733	    038C			 _print_string_with_length_end:
    734	    038C  C3			     ret
    735	    038D			 count_no_space_no_zero_letters:
    736	    038D  5B			     pop bx ; ret address
    737	    038E  5E			     pop si ; string offset
    738	    038F  59			     pop cx ; string length
    739	    0390  53			     push bx ; ret address
    740	    0391  B8 0000		     mov ax, 0
    741	    0394			 _count_non_space_symbols_loop:
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 14
2tree.ASM



    742	    0394  80 3C	20		     cmp byte ptr [si],	20h
    743	    0397  74 12			     je	_count_non_space_symbols_end
    744	    0399  80 3C	0D		     cmp byte ptr [si],	0Dh
    745	    039C  74 0D			     je	_count_non_space_symbols_end
    746	    039E  80 3C	00		     cmp byte ptr [si],	00h
    747	    03A1  74 08			     je	_count_non_space_symbols_end
    748	    03A3  3B C1			     cmp ax, cx
    749	    03A5  74 04			     je	_count_non_space_symbols_end
    750	    03A7  40			     inc ax
    751	    03A8  46			     inc si
    752	    03A9  EB E9			     jmp _count_non_space_symbols_loop
    753	    03AB			 _count_non_space_symbols_end:
    754	    03AB  C3			     ret
    755	    03AC			 count_subfiles_here:
    756	    03AC  B8 0451r		     mov ax, offset file_mask
    757	    03AF  50			     push ax
    758	    03B0  E8 0013		     call count_subfiles_here_by_mask
    759					     load <ax>
2   760	    03B3  50				 push ax
    761	    03B4  B8 0457r		     mov ax, offset folder_mask
    762	    03B7  50			     push ax
    763	    03B8  E8 000B		     call count_subfiles_here_by_mask
    764	    03BB  8B D8			     mov bx, ax
    765					     restore <ax>
2   766	    03BD  58				 pop ax
    767	    03BE  03 D8			     add bx, ax
    768	    03C0  8B C3			     mov ax, bx
    769	    03C2  A3 044Cr		     mov word ptr [current_max_entities], ax
    770	    03C5  C3			     ret
    771	    03C6			 count_subfiles_here_by_mask:
    772	    03C6  5B			     pop bx
    773	    03C7  58			     pop ax		 ; mask	address
    774	    03C8  53			     push bx
    775
    776					     load <ax>
2   777	    03C9  50				 push ax
    778	    03CA  B9 000B		     mov cx, 11		 ; set pointer to count_dta
    779	    03CD  51			     push cx
    780	    03CE  E8 FF70		     call set_dta
    781					     restore <ax>
2   782	    03D1  58				 pop ax
    783
    784	    03D2  B9 0000		     mov cx, 0
    785					     load <cx>
2   786	    03D5  51				 push cx
    787	    03D6  50			     push ax
    788	    03D7  E8 FE94		     call find_first
    789	    03DA  72 1B			     jc	_count_subfiles_from_end
    790	    03DC			 _count_subfiles_from_loop:
    791	    03DC  B9 000B		     mov cx, 11
    792	    03DF  51			     push cx
    793	    03E0  E8 FDFF		     call move_dta
    794	    03E3  05 001E		     add ax, 1Eh
    795	    03E6  8B D8			     mov bx, ax
    796	    03E8  80 3F	2E		     cmp byte ptr [bx],	'.'
    797	    03EB  74 03			     je	_count_subfiles_from_loop_next
    798
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 15
2tree.ASM



    799					     restore <cx>
2   800	    03ED  59				 pop cx
    801	    03EE  41			     inc cx
    802					     load <cx>
2   803	    03EF  51				 push cx
    804	    03F0			 _count_subfiles_from_loop_next:
    805	    03F0  E8 FE76		     call find_next
    806	    03F3  72 02			     jc	_count_subfiles_from_end
    807
    808	    03F5  EB E5			     jmp _count_subfiles_from_loop
    809	    03F7			 _count_subfiles_from_end:
    810					     restore <cx>
2   811	    03F7  59				 pop cx
    812	    03F8  8B C1			     mov ax, cx
    813	    03FA  C3			     ret
    814					 ;
    815					 ; error codes
    816					 ;
    817	    03FB  12			 no_more_files db 18
    818	    03FC  2B			 dta_len db 2bh
    819					 ;
    820					 ; error messages
    821					 ;
    822	    03FD  43 68	61 6E 67 65 20+	 cd_fails db 'Change directory fails.$'
    823		  64 69	72 65 63 74 6F+
    824		  72 79	20 66 61 69 6C+
    825		  73 2E	24
    826	    0415  66 69	6E 64 5F 66 69+	 find_first_fails db 'find_first filenames fails.$'
    827		  72 73	74 20 66 69 6C+
    828		  65 6E	61 6D 65 73 20+
    829		  66 61	69 6C 73 2E 24
    830	    0431  66 69	6E 64 5F 6E 65+	 find_next_fails db  'find_next	filenames fails.$'
    831		  78 74	20 66 69 6C 65+
    832		  6E 61	6D 65 73 20 66+
    833		  61 69	6C 73 2E 24
    834					 ;
    835					 ; int variables
    836					 ;
    837	    044C  0000			 current_max_entities dw 0
    838	    044E  0000			 current_id_entity dw 0
    839					 ;
    840					 ;   parse arguments
    841					 ;
    842	    0450  01			 deep_level db 1
    843	    0451  2A			 file_mask db '*'
    844	    0452  2E 2A	00 00 00	 file_ext db '.*', 00h,	00h, 00h
    845	    0457  2A 00			 folder_mask db	'*', 00h
    846	    0459  2A 2E	2A 00		 all_files db '*.*', 00h
    847					 ;
    848					 ;   pseudographic
    849					 ;
    850	    045D  B3 24			 level_shift db	179, '$'
    851	    045F  ?? 20	24		 space db, 32, '$'
    852
    853	    0462  C3 24			 zero_first_file db 195, '$'
    854	    0464  C0 24			 zero_end_file db 192, '$'
    855
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 16
2tree.ASM



    856	    0466  C2 24			 first_file_char db 194, '$'
    857	    0468  C3 24			 middle_file_char db 195, '$'
    858	    046A  C0 24			 end_file_char db 192, '$'
    859					 ;
    860					 ; strings
    861					 ;
    862	    046C  2E 2E	00		 parent_folder db '..',	00h
    863	    046F  40*(00)		 working_folder	db 64 dup(00h)
    864	    04AF  40*(00)		 root_folder db	64 dup(00h)
    865	    04EF  40*(00)		 start_mask db 64 dup(00h)
    866	    052F  0A 24			 newline db 0Ah, '$'
    867	    0531  10CC*(00)		 dta db	4300 dup(0)
    868	    15FD  2B*(00)		 count_dta db 43 dup(0)
    869					 end start
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 17
Symbol Table




Symbol Name			  Type	 Value

??DATE				  Text	 "12/09/19"
??FILENAME			  Text	 "2tree	  "
??TIME				  Text	 "03:27:49"
??VERSION			  Number 040A
@32BIT				  Text	 0
@CODE				  Text	 DGROUP
@CODESIZE			  Text	 0
@CPU				  Text	 0F0FH
@CURSEG				  Text	 _TEXT
@DATA				  Text	 DGROUP
@DATASIZE			  Text	 0
@FILENAME			  Text	 2TREE
@INTERFACE			  Text	 000H
@MODEL				  Text	 1
@STACK				  Text	 DGROUP
@WORDSIZE			  Text	 2
ALL_FILES			  Byte	 DGROUP:0459
CD				  Near	 DGROUP:0326
CD_ERROR			  Near	 DGROUP:0332
CD_FAILS			  Byte	 DGROUP:03FD
COUNT_DTA			  Byte	 DGROUP:15FD
COUNT_NO_SPACE_NO_ZERO_LETTERS	  Near	 DGROUP:038D
COUNT_SUBFILES_HERE		  Near	 DGROUP:03AC
COUNT_SUBFILES_HERE_BY_MASK	  Near	 DGROUP:03C6
CURRENT_ID_ENTITY		  Word	 DGROUP:044E
CURRENT_MAX_ENTITIES		  Word	 DGROUP:044C
DEEP_LEVEL			  Byte	 DGROUP:0450
DTA				  Byte	 DGROUP:0531
DTA_LEN				  Byte	 DGROUP:03FC
END_FILE_CHAR			  Byte	 DGROUP:046A
FILE_EXT			  Byte	 DGROUP:0452
FILE_MASK			  Byte	 DGROUP:0451
FIND_FIRST			  Near	 DGROUP:026E
FIND_FIRST_ERROR		  Near	 DGROUP:020B
FIND_FIRST_FAILS		  Byte	 DGROUP:0415
FIND_NEXT			  Near	 DGROUP:0269
FIND_NEXT_ERROR			  Near	 DGROUP:021A
FIND_NEXT_FAILS			  Byte	 DGROUP:0431
FIRST_FILE_CHAR			  Byte	 DGROUP:0466
FOLDER_MASK			  Byte	 DGROUP:0457
IS_FOLDER			  Near	 DGROUP:01F4
IS_VALID_NAME			  Near	 DGROUP:027B
LEVEL_SHIFT			  Byte	 DGROUP:045D
LIST_SUBFILES_RECURSIVE		  Near	 DGROUP:0149
LIST_SUBFILES_RECURSIVE_FROM	  Near	 DGROUP:0123
MIDDLE_FILE_CHAR		  Byte	 DGROUP:0468
MOVE_DTA			  Near	 DGROUP:01E2
NEWLINE				  Byte	 DGROUP:052F
NO_MORE_FILES			  Byte	 DGROUP:03FB
PARENT_FOLDER			  Byte	 DGROUP:046C
PARSE_ARGS			  Near	 DGROUP:0241
PARSE_COMMAND_LINE		  Near	 DGROUP:022C
PARSE_D				  Near	 DGROUP:024F
PARSE_END			  Near	 DGROUP:0268
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 18
Symbol Table



PARSE_F				  Near	 DGROUP:025C
PRINT_PSEUDOGRAPHIC_PREFIX	  Near	 DGROUP:02C7
PRINT_STRING_WITH_LENGTH	  Near	 DGROUP:0377
ROOT_FOLDER			  Byte	 DGROUP:04AF
SAVE_CWD			  Near	 DGROUP:0359
SET_DTA				  Near	 DGROUP:0341
SHOW_FILENAME_FROM_DTA		  Near	 DGROUP:0293
SPACE				  Byte	 DGROUP:045F
START				  Near	 DGROUP:0100
START_MASK			  Byte	 DGROUP:04EF
WORKING_FOLDER			  Byte	 DGROUP:046F
ZERO_END_FILE			  Byte	 DGROUP:0464
ZERO_FIRST_FILE			  Byte	 DGROUP:0462
_COUNT_NON_SPACE_SYMBOLS_END	  Near	 DGROUP:03AB
_COUNT_NON_SPACE_SYMBOLS_LOOP	  Near	 DGROUP:0394
_COUNT_SUBFILES_FROM_END	  Near	 DGROUP:03F7
_COUNT_SUBFILES_FROM_LOOP	  Near	 DGROUP:03DC
_COUNT_SUBFILES_FROM_LOOP_NEXT	  Near	 DGROUP:03F0
_IS_FOLDER_END			  Near	 DGROUP:020A
_IS_FOLDER_FALSE		  Near	 DGROUP:0205
_IS_FOLDER_TRUE			  Near	 DGROUP:0200
_IS_VALID_NAME_END		  Near	 DGROUP:0292
_LIST_SUBFILES_RECURSIVE_END	  Near	 DGROUP:01DD
_LIST_SUBFILES_RECURSIVE_LOOP	  Near	 DGROUP:016B
_LIST_SUBFILES_RECURSIVE_NEXT	  Near	 DGROUP:01D2
_PRINT_PSEUDOGRAPHIC_PREFIX_END	  Near	 DGROUP:0325
_PRINT_PSEUDOGRAPHIC_PREFIX_LOOP  Near	 DGROUP:02DD
_PRINT_PSEUDOGRAPHIC_PREFIX_ZERO  Near	 DGROUP:02E9
_LEVEL
_PRINT_PSEUDOGRAPHIC_PREFIX_ZERO  Near	 DGROUP:031C
_LEVEL_END
_PRINT_PSEUDOGRAPHIC_PREFIX_ZERO  Near	 DGROUP:030A
_LEVEL_FIRST
_PRINT_PSEUDOGRAPHIC_PREFIX_ZERO  Near	 DGROUP:0313
_LEVEL_MIDDLE
_PRINT_STRING_WITH_LENGTH_END	  Near	 DGROUP:038C
_PRINT_STRING_WITH_LENGTH_LOOP	  Near	 DGROUP:037D
_SHOW_FILENAME_FROM_DTA_VALID_NA  Near	 DGROUP:0297
ME

Macro Name

BREAK_POINT
CLEAR_MES
EXIT
GET_OFFSET
GET_TRANSITION
LOAD
PRINT
PRINT_RANGE
PUT
RESTORE
SET_TRANSITION
SET_TRANSITION_FOR_ALL
SET_TRANSITION_FOR_DIGITS
SET_TRANSITION_FOR_LETTERS
SET_TRANSITION_LENGTH_FROM_START
Turbo Assembler	 Version 4.1	    12/09/19 03:27:50	    Page 19
Symbol Table



SET_ZERO
TO_NON_SPACE

Groups & Segments		  Bit Size Align  Combine Class

DGROUP				  Group
  _DATA				  16  0000 Word	  Public  DATA
  _TEXT				  16  1628 Word	  Public  CODE
